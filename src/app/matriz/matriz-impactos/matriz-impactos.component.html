<!-- src/app/matriz-impactos/matriz-impactos.component.html -->

<body class="layout-fixed">
  <div class="wrapper">
    <app-nav></app-nav>
    <div class="content-wrapper">
      <div class="matrices-container">
        <h1 class="matriz-title">Matriz de Impactos</h1>

        <!-- Campo de b√∫squeda por Organizaci√≥n -->
        <div class="filter-wrapper">
          <div class="input-row filter-container">
            <div class="input-group">
              <label class="small-text">Filtrar por Organizaci√≥n:</label>
              <input type="text" [(ngModel)]="organizationFilter" placeholder="üîé Escriba para filtrar..."
                class="custom-input small-text" />
            </div>
          </div>
        </div>



        <!-- Vista de lista, si NO hay selectedMatrix -->
        <div *ngIf="!selectedMatrix">
          <!-- Spinner de lista -->
          <div *ngIf="loadingList" class="d-flex justify-content-center my-4">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Cargando matrices...</span>
            </div>
          </div>


          <!-- Tabla tras cargar -->
          <div *ngIf="!loadingList">
            <div *ngIf="filteredMatrices.length === 0">
              <p class="small-text">No hay matrices registradas.</p>
            </div>
            <div *ngIf="filteredMatrices.length > 0" class="table-container">
              <div class="table-wrapper">
                <table>
                  <colgroup>
                    <col class="col-fecha" />
                    <col class="col-organizacion" />
                    <col class="col-accion" />
                  </colgroup>
                  <thead>
                    <tr>
                      <th class="small-text">Fecha</th>
                      <th class="small-text">Organizaci√≥n</th>
                      <th class="small-text">Acci√≥n</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let matriz of filteredMatrices" class="small-text">
                      <td style="text-align: center;">
                        {{ matriz.fecha | date:'dd/MM/yyyy' }}
                      </td>
                      <td style="text-align: center;">
                        {{ matriz.razonSocial || '‚Äî' }}
                      </td>
                      <td style="text-align: center;">
                        <button type="button" class="btn-success btn-sm" (click)="viewDetails(matriz)">
                          <i class="nav-icon fa-solid fa-bolt"></i> Matriz impacto
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Detalle de la matriz seleccionada -->
        <div *ngIf="selectedMatrix">
          <!-- Spinner de detalle -->
          <div *ngIf="loadingDetail" class="d-flex justify-content-center my-4">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Cargando detalle...</span>
            </div>
          </div>

          <!-- ‚ñº Selector de modos (estilo actualizado) -->
          <div class="mode-selector mb-3">
            <ng-container *ngIf="!selectedViewMode">
              <h5 class="small-text">¬øC√≥mo deseas visualizar la matriz?</h5>
              <button class="btn btn-outline-secondary btn-sm me-2" (click)="setViewMode('stages')">
                <i class="fa-solid fa-layer-group me-1"></i> Separado por etapas
              </button>
              <button class="btn btn-outline-secondary btn-sm me-2" (click)="setViewMode('combined')">
                <i class="fa-solid fa-th-large me-1"></i> Separado por etapa y sistema
              </button>
              <button class="btn btn-outline-secondary btn-sm" (click)="setViewMode('systems')">
                <i class="fa-solid fa-sitemap me-1"></i> Separado por sistemas
              </button>
            </ng-container>

            <ng-container *ngIf="selectedViewMode">
              <button type="button" class="btn btn-sm btn-secondary" (click)="resetViewMode()">
                ‚Üê Volver
              </button>
            </ng-container>
          </div>



          <!-- Contenido de detalle tras cargar -->
          <div *ngIf="!loadingDetail">
            <p class="small-text">
              <strong>Fecha:</strong> {{ selectedMatrix.fecha | date:'dd/MM/yyyy' }}
            </p>
            <p class="small-text">
              <strong>Organizaci√≥n:</strong>
              {{ selectedMatrix.items[0].razonSocial || '‚Äî' }}
            </p>

            <!-- Tabla de Factores/Etapas/Acciones -->
            <ng-container *ngIf="selectedViewMode===null">
              <div #tableEl>
                <!-- Tabla de Factores/Etapas/Acciones -->
                <div #matrizVisualizacion class="table-container">
                  <style>
                    table thead th.stage-construccion {
                      background-color: #add8e6 !important;
                    }

                    table thead th.stage-funcionamiento {
                      background-color: #ffa500 !important;
                    }

                    table thead th.stage-abandono {
                      background-color: #ff0000 !important;
                    }

                    table thead th.stage-comunes {
                      background-color: #ee82ee !important;
                    }
                  </style>

                  <table>
                    <thead>
                      <tr>
                        <th rowspan="2">Sistema</th>
                        <th rowspan="2">Subsistema</th>
                        <th rowspan="2">Factor</th>
                        <th rowspan="2">Componente</th>
                        <th rowspan="2">UIP</th>
                        <th *ngFor="let st of stages" [attr.colspan]="st.actions.length" class="small-text"
                          [ngClass]="getStageClass(st.name)">
                          {{ st.name }}
                        </th>
                        <th rowspan="2" class="small-text uip-column">IAT</th>
                        <th rowspan="2" class="small-text uip-column">IRT</th>
                      </tr>
                      <tr>
                        <ng-container *ngFor="let st of stages">
                          <th *ngFor="let action of st.actions" class="small-text">
                            {{ action }}
                          </th>
                        </ng-container>
                      </tr>
                    </thead>
                    <tbody>
                      <ng-container *ngFor="let factor of factors; let i = index">
                        <!-- Fila de datos -->
                        <tr>
                          <td *ngIf="isFirstOfSystemFactor(i)" [attr.rowspan]="getSystemRowSpanFactor(i)">
                            {{ factor.sistema }}
                          </td>
                          <td>{{ factor.subsistema }}</td>
                          <td>{{ factor.factor }}</td>
                          <td>
                            <button (click)="toggleFactor(factor.id.toString())">
                              {{ expandedFactors[factor.id.toString()] ? '‚Äì' : '+' }}
                            </button>

                            {{ factor.componente}}
                          </td>
                          <td>{{ getUIPValue(factor.id) }}</td>

                          <!-- Para cada etapa/acci√≥n -->
                          <ng-container *ngFor="let st of stages">
                            <td *ngFor="let action of st.actions" [ngClass]="{
                              'cell-positive': valuationsMap[factor.id]?.[st.name]?.[action] === 'positivo',
                              'cell-negative': valuationsMap[factor.id]?.[st.name]?.[action] === 'negativo',
                              'cell-neutral': valuationsMap[factor.id]?.[st.name]?.[action] === 'neutro'
                            }" [attr.title]="factor.factor + ' ‚Äì ' + factor.componente + ' ‚Äì ' + action">
                              <table>
                                <tbody>
                                  <tr>
                                    <td class="small-text2">Natu:</td>
                                    <td class="small-text2">
                                      {{
                                      valuationsMap[factor.id]?.[st.name]?.[action] ===
                                      'positivo'
                                      ? '+'
                                      : valuationsMap[factor.id]?.[st.name]?.[
                                      action
                                      ] === 'negativo'
                                      ? '‚àí'
                                      : valuationsMap[factor.id]?.[st.name]?.[
                                      action
                                      ] === 'neutro'
                                      ? '0'
                                      : '--'
                                      }}
                                    </td>
                                  </tr>

                                  <ng-container *ngIf="expandedFactors[factor.id]">
                                    <tr>
                                      <td class="small-text2">Int:</td>
                                      <td>
                                        <select [(ngModel)]="
                                        getAdditional(factor.id, st.name, action)
                                          .intensidad
                                      " class="custom-input small-text">
                                          <option *ngFor="let opt of intensidadOptions" [ngValue]="opt.value">
                                            {{ opt.label }}
                                          </option>
                                        </select>
                                      </td>
                                    </tr>
                                    <tr>
                                      <td class="small-text2">Ext:</td>
                                      <td>
                                        <select [(ngModel)]="
                                        getAdditional(factor.id, st.name, action)
                                          .extension
                                      " class="custom-input small-text">
                                          <option *ngFor="let opt of extensionOptions" [ngValue]="opt.value">
                                            {{ opt.label }}
                                          </option>
                                        </select>
                                      </td>
                                    </tr>
                                    <tr>
                                      <td class="small-text2">Mo:</td>
                                      <td>
                                        <select [(ngModel)]="
                                        getAdditional(factor.id, st.name, action)
                                          .momento
                                      " class="custom-input small-text">
                                          <option *ngFor="let opt of momentoOptions" [ngValue]="opt.value">
                                            {{ opt.label }}
                                          </option>
                                        </select>
                                      </td>
                                    </tr>
                                    <tr>
                                      <td class="small-text2">Per:</td>
                                      <td>
                                        <select [(ngModel)]="
                                        getAdditional(factor.id, st.name, action)
                                          .persistencia
                                      " class="custom-input small-text">
                                          <option *ngFor="let opt of persistenciaOptions" [ngValue]="opt.value">
                                            {{ opt.label }}
                                          </option>
                                        </select>
                                      </td>
                                    </tr>
                                    <tr>
                                      <td class="small-text2">Rever:</td>
                                      <td>
                                        <select [(ngModel)]="
                                        getAdditional(factor.id, st.name, action)
                                          .reversibilidad
                                      " class="custom-input small-text">
                                          <option *ngFor="let opt of reversibilidadOptions" [ngValue]="opt.value">
                                            {{ opt.label }}
                                          </option>
                                        </select>
                                      </td>
                                    </tr>
                                    <tr>
                                      <td class="small-text2">Siner:</td>
                                      <td>
                                        <select [(ngModel)]="
                                        getAdditional(factor.id, st.name, action)
                                          .sinergia
                                      " class="custom-input small-text">
                                          <option *ngFor="let opt of sinergiaOptions" [ngValue]="opt.value">
                                            {{ opt.label }}
                                          </option>
                                        </select>
                                      </td>
                                    </tr>
                                    <tr>
                                      <td class="small-text2">Acumu:</td>
                                      <td>
                                        <select [(ngModel)]="
                                        getAdditional(factor.id, st.name, action)
                                          .acumulacion
                                      " class="custom-input small-text">
                                          <option *ngFor="let opt of acumulacionOptions" [ngValue]="opt.value">
                                            {{ opt.label }}
                                          </option>
                                        </select>
                                      </td>
                                    </tr>
                                    <tr>
                                      <td class="small-text2">Efec:</td>
                                      <td>
                                        <select [(ngModel)]="
                                        getAdditional(factor.id, st.name, action)
                                          .efecto
                                      " class="custom-input small-text">
                                          <option *ngFor="let opt of efectoOptions" [ngValue]="opt.value">
                                            {{ opt.label }}
                                          </option>
                                        </select>
                                      </td>
                                    </tr>
                                    <tr>
                                      <td class="small-text2">Perio:</td>
                                      <td>
                                        <select [(ngModel)]="
                                        getAdditional(factor.id, st.name, action)
                                          .periodicidad
                                      " class="custom-input small-text">
                                          <option *ngFor="let opt of periodicidadOptions" [ngValue]="opt.value">
                                            {{ opt.label }}
                                          </option>
                                        </select>
                                      </td>
                                    </tr>
                                    <tr>
                                      <td class="small-text2">Recu:</td>
                                      <td>
                                        <select [(ngModel)]="
                                        getAdditional(factor.id, st.name, action)
                                          .recuperacion
                                      " class="custom-input small-text">
                                          <option *ngFor="let opt of recuperacionOptions" [ngValue]="opt.value">
                                            {{ opt.label }}
                                          </option>
                                        </select>
                                      </td>
                                    </tr>
                                  </ng-container>

                                  <tr [ngClass]="getImpactClass(factor.id, st.name, action)">
                                    <td class="small-text2">Imp:</td>
                                    <td class="small-text2">
                                      {{ calculateImpact(factor.id, st.name, action) }}
                                    </td>
                                  </tr>

                                </tbody>
                              </table>
                            </td>
                          </ng-container>

                          <td class="small-text" style="text-align:center;">
                            {{ calculateImportanciaAbsolutaTotal(factor.id) | number:'1.0-1' }}
                          </td>
                          <td class="small-text" style="text-align:center;">
                            {{ calculateImportanciaRelativaTotalFactor(factor.id) | number:'1.0-1' }}
                          </td>
                        </tr>

                        <!-- fila resumen por sistema -->
                        <tr *ngIf="isLastOfSystemFactor(i)" class="total-row">
                          <td colspan="5" class="small-text">
                            <strong>Total {{ factor.sistema }}</strong>
                          </td>
                          <ng-container *ngFor="let st of stages">
                            <td *ngFor="let action of st.actions" class="small-text">
                              <strong>
                                {{ getGroupImpactSum(factor.sistema, st.name, action) | number:'1.0-1' }}
                              </strong>
                            </td>
                          </ng-container>
                          <td class="small-text" style="text-align:center;">
                            <strong>{{ getGroupAbsoluta(factor.sistema) | number:'1.0-1' }}</strong>
                          </td>
                          <td class="small-text" style="text-align:center;">
                            <strong>{{ getGroupRelativa(factor.sistema) | number:'1.0-1' }}</strong>
                          </td>
                        </tr>
                      </ng-container>

                      <!-- totales globales -->
                      <tr>
                        <td colspan="5" class="small-text"><strong>IAT</strong></td>
                        <ng-container *ngFor="let st of stages">
                          <td *ngFor="let action of st.actions" class="small-text">
                            <strong>{{ getGlobalActionSum(st.name, action) | number:'1.0-2' }}</strong>
                          </td>
                        </ng-container>
                        <td class="small-text" style="text-align:center;">
                          <strong>{{ getGrandAbsolutaTotal() | number:'1.0-2' }}</strong>
                        </td>
                        <td></td>
                      </tr>
                      <tr>
                        <td colspan="5" class="small-text"><strong>IRT</strong></td>
                        <ng-container *ngFor="let st of stages">
                          <td *ngFor="let action of st.actions" class="small-text">
                            <strong>{{ getGlobalRelativeAction(st.name, action) | number:'1.0-2' }}</strong>
                          </td>
                        </ng-container>
                        <td></td>
                        <td></td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- Bot√≥n de descarga para ‚Äúcompleto‚Äù -->
                <!-- Antes (modo complete) -->
                <button class="btn btn-primary btn-sm mt-2" (click)="downloadTable(tableEl, 'matriz-completa')">
                  <i class="fa-solid fa-download me-1"></i> Descargar Completo
                </button>

              </div>
            </ng-container>

            <!-- ‚ñº Modo ‚ÄúCompleto‚Äù expl√≠cito -->
            <ng-container *ngIf="selectedViewMode==='complete'">
              <div #tableEl>
                <!-- üìã Tabla completa id√©ntica a la original -->
                <div #matrizVisualizacion class="table-container">
                  <!-- ‚Ä¶pon aqu√≠ todo el contenido de tu tabla original‚Ä¶ -->
                </div>
                <button class="btn btn-primary btn-sm mt-2" (click)="downloadTable(tableEl, 'matriz-completa')">
                  <i class="fa-solid fa-download me-1"></i> Descargar Completo
                </button>
              </div>
            </ng-container>


            <!-- ‚ñº Modo ‚ÄúPor Etapas‚Äù -->
            <ng-container *ngIf="selectedViewMode==='stages'">
              <ng-container *ngFor="let st of stages">
                <h5 class="mt-4"><strong>{{ st.name }}</strong></h5>
                <!-- üìå Aqu√≠ movemos el #tableEl dentro del ngFor -->
                <div #tableEl class="table-container-separado">
                  <table class="table table-fixed">
                    <thead>
                      <tr>
                        <th rowspan="2" style="width: 110px;">Sistema</th>
                        <th rowspan="2" style="width: 110px;">Subsistema</th>
                        <th rowspan="2" style="width: 110px;">Factor</th>
                        <th rowspan="2" style="width: 110px;">Componente</th>
                        <th rowspan="2" style="width: 30px;">UIP</th>
                        <th *ngFor="let action of st.actions" class="small-text" [ngClass]="getStageClass(st.name)"
                          [style.width.px]="150">
                          {{ action }}

                        </th>
                        <th rowspan="2" class="small-text uip-column">IAT</th>
                        <th rowspan="2" class="small-text uip-column">IRT</th>
                      </tr>
                      <tr>
                        <th *ngFor="let action of st.actions" class="small-text">
                          {{ action }}
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <ng-container *ngFor="let factor of factors; let i = index">
                        <tr>
                          <td *ngIf="isFirstOfSystemFactor(i)" [attr.rowspan]="getSystemRowSpanFactor(i)">
                            {{ factor.sistema }}
                          </td>
                          <td>{{ factor.subsistema }}</td>
                          <td>{{ factor.factor }}</td>
                          <td>{{ factor.componente }}</td>
                          <td>{{ getUIPValue(factor.id) }}</td>

                          <td *ngFor="let action of st.actions" [ngClass]="{
                      'cell-positive': valuationsMap[factor.id]?.[st.name]?.[action]==='positivo',
                      'cell-negative': valuationsMap[factor.id]?.[st.name]?.[action]==='negativo',
                      'cell-neutral':  valuationsMap[factor.id]?.[st.name]?.[action]==='neutro'
                    }" style="text-align:center;">
                            {{ calculateImpact(factor.id, st.name, action) }}
                          </td>

                          <td class="small-text" style="text-align:center;">
                            {{ calculateImportanciaAbsolutaPorEtapa(factor.id, st.name) | number:'1.0-1' }}
                          </td>
                          <td class="small-text" style="text-align:center;">
                            {{ calculateImportanciaRelativaPorEtapa(factor.id, st.name) | number:'1.0-1' }}
                          </td>
                        </tr>

                        <tr *ngIf="isLastOfSystemFactor(i)" class="total-row">
                          <td colspan="5"><strong>Total {{ factor.sistema }}</strong></td>
                          <td *ngFor="let action of st.actions" class="small-text text-center">
                            <strong>{{ getGroupImpactSum(factor.sistema, st.name, action) | number:'1.0-1' }}</strong>
                          </td>
                          <td class="small-text text-center">
                            <strong>{{ getGroupAbsolutaPorEtapa(factor.sistema, st.name) | number:'1.0-1' }}</strong>
                          </td>
                          <td class="small-text text-center">
                            <strong>{{ getGroupRelativaPorEtapa(factor.sistema, st.name) | number:'1.0-1' }}</strong>
                          </td>
                        </tr>
                      </ng-container>
                    </tbody>
                  </table>
                </div>
                <!-- Bot√≥n justo debajo de cada tabla -->
                <button class="btn btn-primary btn-sm mt-2" (click)="downloadTable(tableEl, 'matriz-etapas-'+st.name)">
                  <i class="fa-solid fa-download me-1"></i> Descargar {{ st.name }}
                </button> {{ st.name }}

              </ng-container>
            </ng-container>

            <!-- ‚ñº Modo ‚ÄúPor Sistemas‚Äù -->
            <ng-container *ngIf="selectedViewMode==='systems'">
              <ng-container *ngFor="let sys of uniqueSystems">
                <h5 class="mt-4"><strong>{{ sys }}</strong></h5>
                <div #tableEl class="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th rowspan="2" style="width: 110px;">Sistema</th>
                        <th rowspan="2" style="width: 110px;">Subsistema</th>
                        <th rowspan="2" style="width: 110px;">Factor</th>
                        <th rowspan="2" style="width: 80px;">Componente</th>
                        <th rowspan="2" style="width: 30px;">UIP</th>
                        <th *ngFor="let st of stages" [attr.colspan]="st.actions.length" class="small-text"
                          [ngClass]="getStageClass(st.name)" [style.width.px]="300" [style.white-space]="'normal'"
                          [style.overflow-wrap]="'break-word'">
                          {{ st.name }}
                        </th>

                        <th rowspan="2" style="width: 10px;">IAT</th>
                        <th rowspan="2" style="width: 10px;">IRT</th>
                      </tr>
                      <tr>
                        <ng-container *ngFor="let st of stages">
                          <th *ngFor="let action of st.actions" class="small-text" [style.width.px]="300">
                            {{ action }}
                          </th>
                        </ng-container>
                      </tr>
                    </thead>
                    <tbody>
                      <ng-container *ngFor="let factor of factors; let i = index">
                        <tr *ngIf="factor.sistema === sys">
                          <td *ngIf="isFirstOfSystemFactor(i)" [attr.rowspan]="getSystemRowSpanFactor(i)">
                            {{ factor.sistema }}
                          </td>
                          <td>{{ factor.subsistema }}</td>
                          <td>{{ factor.factor }}</td>
                          <td>{{ factor.componente }}</td>
                          <td>{{ getUIPValue(factor.id) }}</td>

                          <ng-container *ngFor="let st of stages">
                            <td *ngFor="let action of st.actions" [ngClass]="{
                        'cell-positive': valuationsMap[factor.id]?.[st.name]?.[action]==='positivo',
                        'cell-negative': valuationsMap[factor.id]?.[st.name]?.[action]==='negativo',
                        'cell-neutral':  valuationsMap[factor.id]?.[st.name]?.[action]==='neutro'
                     }" style="text-align:center; white-space: normal; overflow-wrap: break-word;">
                              {{ calculateImpact(factor.id, st.name, action) }}
                            </td>
                          </ng-container>

                          <td class="small-text" style="text-align:center;">
                            {{ calculateImportanciaAbsolutaTotal(factor.id) | number:'1.0-1' }}
                          </td>
                          <td class="small-text" style="text-align:center;">
                            {{ calculateImportanciaRelativaTotalFactor(factor.id) | number:'1.0-1' }}
                          </td>
                        </tr>

                        <tr *ngIf="factor.sistema===sys && isLastOfSystemFactor(i)" class="total-row">
                          <td colspan="5"><strong>Total {{ sys }}</strong></td>
                          <ng-container *ngFor="let st of stages">
                            <td *ngFor="let action of st.actions" class="small-text text-center">
                              <strong>
                                {{ getGroupImpactSum(sys, st.name, action) | number:'1.0-1' }}
                              </strong>
                            </td>
                          </ng-container>
                          <td class="small-text text-center">
                            <strong>{{ getGroupAbsoluta(sys) | number:'1.0-1' }}</strong>
                          </td>
                          <td class="small-text text-center">
                            <strong>{{ getGroupRelativa(sys) | number:'1.0-1' }}</strong>
                          </td>
                        </tr>
                      </ng-container>
                    </tbody>
                  </table>
                </div>
                <button class="btn btn-primary btn-sm mt-2" [disabled]="loadingDownloads['matriz-sistemas-'+sys]"
                  (click)="downloadTable(tableEl, 'matriz-sistemas-'+sys)">
                  <app-spinner [isVisible]="loadingDownloads['matriz-sistemas-'+sys]" class="me-1"></app-spinner>
                  <i class="fa-solid fa-download me-1"></i>
                  Descargar {{ sys }}
                </button>

              </ng-container>
            </ng-container>


            <!-- ‚ñº Modo ‚ÄúCombinado‚Äù -->
            <ng-container *ngIf="selectedViewMode==='combined'">
              <ng-container *ngFor="let st of stages">
                <h5 class="mt-4"><strong>{{ st.name }}</strong></h5>
                <ng-container *ngFor="let sys of uniqueSystems">
                  <h6 class="ms-3"><strong>{{ sys }}</strong></h6>
                  <div #tableEl class="table-container-separado">
                    <table>
                      <thead>
                        <tr>
                          <th rowspan="2" style="width: 110px;">Sistema</th>
                          <th rowspan="2" style="width: 110px;">Subsistema</th>
                          <th rowspan="2" style="width: 110px;">Factor</th>
                          <th rowspan="2" style="width: 80px;">Componente</th>
                          <th rowspan="2" style="width: 30px;">UIP</th>
                          <th *ngFor="let action of st.actions" class="small-text" [ngClass]="getStageClass(st.name)"
                            [style.width.px]="150" [style.white-space]="'normal'" [style.overflow-wrap]="'break-word'">
                            {{ action }}
                          </th>
                          <th rowspan="2" class="small-text uip-column">IAT</th>
                          <th rowspan="2" class="small-text uip-column">IRT</th>
                        </tr>
                        <tr>
                          <th *ngFor="let action of st.actions" class="small-text">
                            {{ action }}
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        <ng-container *ngFor="let factor of factors; let i = index">
                          <tr *ngIf="factor.sistema === sys">
                            <td *ngIf="isFirstOfSystemFactor(i)" [attr.rowspan]="getSystemRowSpanFactor(i)">
                              {{ factor.sistema }}
                            </td>
                            <td>{{ factor.subsistema }}</td>
                            <td>{{ factor.factor }}</td>
                            <td>{{ factor.componente }}</td>
                            <td>{{ getUIPValue(factor.id) }}</td>

                            <td *ngFor="let action of st.actions" [ngClass]="{
                        'cell-positive': valuationsMap[factor.id]?.[st.name]?.[action]==='positivo',
                        'cell-negative': valuationsMap[factor.id]?.[st.name]?.[action]==='negativo',
                        'cell-neutral':  valuationsMap[factor.id]?.[st.name]?.[action]==='neutro'
                      }" style="text-align:center;">
                              {{ calculateImpact(factor.id, st.name, action) }}
                            </td>

                            <td class="small-text" style="text-align:center;">
                              {{ calculateImportanciaAbsolutaPorEtapa(factor.id, st.name) | number:'1.0-1' }}
                            </td>
                            <td class="small-text" style="text-align:center;">
                              {{ calculateImportanciaRelativaPorEtapa(factor.id, st.name) | number:'1.0-1' }}
                            </td>
                          </tr>
                          <tr *ngIf="factor.sistema === sys && isLastOfSystemFactor(i)" class="total-row">
                            <td colspan="5"><strong>Total {{ sys }}</strong></td>
                            <td *ngFor="let action of st.actions" class="small-text text-center">
                              <strong>{{ getGroupImpactSum(sys, st.name, action) | number:'1.0-1' }}</strong>
                            </td>
                            <td class="small-text text-center">
                              <strong>{{ getGroupAbsolutaPorEtapa(sys, st.name) | number:'1.0-1' }}</strong>
                            </td>
                            <td class="small-text text-center">
                              <strong>{{ getGroupRelativaPorEtapa(sys, st.name) | number:'1.0-1' }}</strong>
                            </td>
                          </tr>
                        </ng-container>
                      </tbody>
                    </table>
                  </div>
                  <button class="btn btn-primary btn-sm mt-2" [disabled]="loadingDownloads['matriz-etapas-'+st.name]"
                    (click)="downloadTable(tableEl, 'matriz-etapas-'+st.name)">
                    <app-spinner [isVisible]="loadingDownloads['matriz-etapas-'+st.name]" class="me-1"></app-spinner>
                    <i class="fa-solid fa-download me-1"></i>
                    Descargar {{ st.name }}
                  </button>
                </ng-container>
              </ng-container>
            </ng-container>



            <button type="button" class="btn-primary small-text btn-spacing" (click)="updateAdditionalValues()">
              <i class="fas fa-save"></i> Guardar Valores Adicionales
            </button>
            <button type="button" class="btn-secondary small-text btn-spacing" (click)="backToList()">
              <i class="fas fa-arrow-left"></i> Volver a la lista
            </button>
            <button type="button" class="btn-info small-text btn-spacing" (click)="showNumericPopup()">
              <i class="fas fa-list"></i> Ver Matriz Num√©rica
            </button>

            <!-- Resumen - Top 3 IRT Positivos (solo > 0) -->
            <div class="card summary-card" *ngIf="topThreePosIRTsFiltered.length > 0">
              <h3>Resumen - Top 3 IRT Factores Positivos</h3>
              <ul>
                <li *ngFor="let item of topThreePosIRTsFiltered">
                  Factor: {{ item.factor }} | IRT:
                  <span [ngClass]="{ 'positive-value': item.irt > 0 }">
                    {{ item.irt | number:'1.0-2' }}
                  </span>
                </li>
              </ul>
            </div>


            <!-- Resumen - Top 3 IRT Negativos con Acciones -->
            <div class="card summary-card" *ngIf="topThreeNegIRTs.length > 0">
              <h3>Resumen - Top 3 IRT Factores Negativos</h3>
              <ul>
                <li *ngFor="let item of topThreeNegIRTs">
                  Factor: {{ item.factor }} | IRT:
                  <span [ngClass]="{ 'negative-value': item.irt < 0 }">
                    {{ item.irt | number:'1.0-2' }}
                  </span>

                </li>
              </ul>
            </div>

            <!-- Top 3 IRT Positivos por Acci√≥n y Etapa -->
            <div class="card summary-card" *ngIf="topThreeActionPosIRTs.length > 0">
              <h3>Top 3 IRT Positivos por Acci√≥n y Etapa</h3>
              <ul>
                <li *ngFor="let item of topThreeActionPosIRTs">
                  Etapa: {{ item.etapa }} | Acci√≥n: {{ item.accion }} | IRT:
                  <span class="positive-value">
                    {{ item.irt | number:'1.0-2' }}
                  </span>
                </li>
              </ul>
            </div>

            <!-- Top 3 IRT Negativos por Acci√≥n y Etapa -->
            <div class="card summary-card" *ngIf="topThreeActionNegIRTs.length > 0">
              <h3>Top 3 IRT Negativos por Acci√≥n y Etapa</h3>
              <ul>
                <li *ngFor="let item of topThreeActionNegIRTs">
                  Etapa: {{ item.etapa }} | Acci√≥n: {{ item.accion }} | IRT:
                  <span class="negative-value">
                    {{ item.irt | number:'1.0-2' }}
                  </span>
                </li>
              </ul>
            </div>


            <!-- Gr√°fico IRT -->
            <div class="card chart-card" *ngIf="shouldShowIrtBarChart()">
              <h3>Gr√°fico de Barras - IRT de cada Factor</h3>
              <canvas id="irtBarChart" #irtBarChart style="width: 100%; height: 400px;"></canvas>
              <div class="mb-2">
                <button class="btn btn-primary btn-sm" (click)="downloadIrtChart()">
                  <i class="fa-solid fa-download me-1"></i>
                  {{ sectionId ? 'Asociar gr√°fico IRT' : 'Descargar JPG' }}
                </button>
              </div>
            </div>

            <!-- Gr√°fico de Acciones -->
            <div class="card chart-card" *ngIf="shouldShowIrtActionsChart()">
              <h3>Gr√°fico de Barras - IRT por Acciones y Factores</h3>
              <canvas id="irtActionsChart" #irtActionsChart style="width: 100%; height: 400px;"></canvas>
              <div class="mb-2">
                <button class="btn btn-primary btn-sm" (click)="downloadActionsChart()">
                  <i class="fa-solid fa-download me-1"></i>
                  {{ sectionId ? 'Asociar gr√°fico de Acciones' : 'Descargar JPG' }}
                </button>
              </div>
            </div>

            <!-- 1. S√≥lo Factores -->
            <div class="card chart-card" *ngIf="shouldShowFactorsChart()">
              <h3 class="text-center">IRT por Factor</h3>

              <!-- Contenedor flex para centrar el chart-area -->
              <div class="d-flex justify-content-center">
                <!-- chart-area con ancho m√°ximo y responsivo -->
                <div class="chart-area w-100" style="max-width: 600px; height: 300px;">
                  <canvas #factorsCanvas></canvas>
                </div>
              </div>

              <!-- Bot√≥n centrado -->
              <div class="d-flex justify-content-center mb-2">
                <button class="btn btn-primary btn-sm" (click)="downloadChart(factorsChart, 'irt-factores')">
                  <i class="fa-solid fa-download me-1"></i>
                  Descargar JPG
                </button>
              </div>
            </div>



            <!-- 2. S√≥lo Acciones -->
            <div class="card chart-card" *ngIf="shouldShowActionsOnlyChart()">
              <h3 class="text-center">IRT por Acci√≥n</h3>

              <div class="d-flex justify-content-center">
                <div class="chart-area w-100" style="max-width: 600px; height: 300px;">
                  <canvas #actionsOnlyCanvas></canvas>
                </div>
              </div>

              <div class="d-flex justify-content-center mb-2">
                <button class="btn btn-primary btn-sm" (click)="downloadChart(actionsOnlyChart, 'irt-acciones')">
                  <i class="fa-solid fa-download me-1"></i>
                  Descargar JPG
                </button>
              </div>
            </div>

            <!-- 3. Acciones por Etapa 
            <div class="card chart-card" *ngIf="shouldShowActionsByStageChart()">
              <h3 class="text-center">IRT por Etapa y Acci√≥n</h3>

              <div class="d-flex justify-content-center">
                <div class="chart-area w-100" style="max-width: 600px; height: 300px;">
                  <canvas #actionsByStageCanvas></canvas>
                </div>
              </div>

              <div class="d-flex justify-content-center mb-2">
                <button class="btn btn-primary btn-sm"
                  (click)="downloadChart(actionsByStageChart, 'irt-por-etapa-accion')">
                  <i class="fa-solid fa-download me-1"></i>
                  Descargar JPG
                </button>
              </div>
            </div>

            -->

          </div>
        </div>
      </div>
    </div>
    <app-footer></app-footer>
  </div>
</body>